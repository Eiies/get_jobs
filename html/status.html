<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ä»»åŠ¡çŠ¶æ€ç›‘æ§</title>
    <link href="bootstrap.min.css" rel="stylesheet" />
    <style>
      @font-face {
        font-family: "DroidSansMono";
        src: url("DroidSansMonoDotted.ttf") format("truetype");
      }
      body {
        font-family: "DroidSansMono", sans-serif;
        padding: 30px;
        background-color: #f8f9fa;
      }
      .card {
        margin-bottom: 20px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      }
      .progress {
        height: 25px;
      }
      .progress-bar {
        font-size: 14px;
        line-height: 25px;
      }
      .log-container {
        max-height: 400px;
        overflow-y: auto;
        background-color: #f8f9fa;
        border-radius: 5px;
        padding: 10px;
        border: 1px solid #dee2e6;
      }
      .log-entry {
        margin-bottom: 5px;
        padding: 5px;
        border-bottom: 1px solid #eee;
      }
      .log-entry.error {
        color: #dc3545;
        background-color: #f8d7da;
      }
      .platform-badge {
        font-size: 16px;
        padding: 8px 12px;
        margin-right: 10px;
      }
      .refresh-btn {
        margin-bottom: 20px;
      }
      #lastUpdate {
        font-size: 12px;
        color: #6c757d;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1 class="text-center mb-4">ğŸ€Get Jobs ä»»åŠ¡çŠ¶æ€ç›‘æ§</h1>

      <div class="text-center mb-4">
        <button id="refreshBtn" class="btn btn-primary refresh-btn">
          <i class="bi bi-arrow-clockwise"></i> åˆ·æ–°çŠ¶æ€
        </button>
        <span id="lastUpdate" class="ms-2"></span>
      </div>

      <div class="row">
        <div class="col-md-12">
          <div class="card">
            <div class="card-header bg-primary text-white">
              <h4 class="mb-0">å½“å‰ä»»åŠ¡çŠ¶æ€</h4>
            </div>
            <div class="card-body">
              <div class="d-flex align-items-center mb-3">
                <span class="badge bg-info platform-badge" id="platformBadge"
                  >å‡†å¤‡ä¸­</span
                >
                <span class="badge bg-secondary platform-badge" id="statusBadge"
                  >æœªå¼€å§‹</span
                >
                <span class="ms-auto" id="durationSpan"
                  >è¿è¡Œæ—¶é—´: 00:00:00</span
                >
              </div>

              <div class="progress mb-3">
                <div
                  id="progressBar"
                  class="progress-bar progress-bar-striped progress-bar-animated"
                  role="progressbar"
                  style="width: 0%"
                  aria-valuenow="0"
                  aria-valuemin="0"
                  aria-valuemax="100"
                >
                  0%
                </div>
              </div>

              <div class="d-flex justify-content-between">
                <span id="processedCount">å·²å¤„ç†: 0</span>
                <span id="totalCount">æ€»ä»»åŠ¡: 0</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="row">
        <div class="col-md-12">
          <div class="card">
            <div class="card-header bg-success text-white">
              <h4 class="mb-0">æ´»åŠ¨æ—¥å¿—</h4>
            </div>
            <div class="card-body">
              <div id="logContainer" class="log-container">
                <!-- æ—¥å¿—æ¡ç›®å°†åœ¨è¿™é‡ŒåŠ¨æ€æ·»åŠ  -->
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œ
      document.addEventListener("DOMContentLoaded", function () {
        // åˆå§‹åŠ è½½çŠ¶æ€
        loadStatus();
        loadLogs();

        // è®¾ç½®å®šæ—¶åˆ·æ–°ï¼ˆæ¯5ç§’ï¼‰
        setInterval(function () {
          loadStatus();
          loadLogs();
        }, 5000);

        // åˆ·æ–°æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        document
          .getElementById("refreshBtn")
          .addEventListener("click", function () {
            loadStatus();
            loadLogs();
          });
      });

      // åŠ è½½çŠ¶æ€ä¿¡æ¯
      function loadStatus() {
        fetch("status.json?" + new Date().getTime())
          .then((response) => {
            if (!response.ok) {
              throw new Error("çŠ¶æ€æ–‡ä»¶ä¸å­˜åœ¨æˆ–æ— æ³•è®¿é—®");
            }
            return response.json();
          })
          .then((data) => {
            updateStatusUI(data);
          })
          .catch((error) => {
            console.error("åŠ è½½çŠ¶æ€å¤±è´¥:", error);
            document.getElementById("statusBadge").textContent = "æœªè¿è¡Œ";
            document.getElementById("statusBadge").className =
              "badge bg-danger platform-badge";
          });
      }

      // æ›´æ–°çŠ¶æ€UI
      function updateStatusUI(data) {
        // æ›´æ–°å¹³å°å’ŒçŠ¶æ€
        document.getElementById("platformBadge").textContent =
          data.platform || "æœªçŸ¥å¹³å°";
        document.getElementById("statusBadge").textContent =
          data.status || "æœªçŸ¥çŠ¶æ€";

        // æ ¹æ®çŠ¶æ€è®¾ç½®ä¸åŒçš„é¢œè‰²
        let statusClass = "bg-secondary";
        if (data.status === "å‡†å¤‡ä¸­") statusClass = "bg-warning";
        if (data.status === "è¿è¡Œä¸­") statusClass = "bg-success";
        if (data.status === "å·²å®Œæˆ") statusClass = "bg-info";
        if (data.status === "å‡ºé”™") statusClass = "bg-danger";
        document.getElementById("statusBadge").className =
          "badge " + statusClass + " platform-badge";

        // æ›´æ–°è¿›åº¦æ¡
        const progressBar = document.getElementById("progressBar");
        progressBar.style.width = data.progress + "%";
        progressBar.textContent = data.progress + "%";
        progressBar.setAttribute("aria-valuenow", data.progress);

        // æ›´æ–°è®¡æ•°
        document.getElementById("processedCount").textContent =
          "å·²å¤„ç†: " + data.processed;
        document.getElementById("totalCount").textContent =
          "æ€»ä»»åŠ¡: " + data.total;

        // æ›´æ–°è¿è¡Œæ—¶é—´
        document.getElementById("durationSpan").textContent =
          "è¿è¡Œæ—¶é—´: " + data.duration;

        // æ›´æ–°æœ€åæ›´æ–°æ—¶é—´
        document.getElementById("lastUpdate").textContent =
          "æœ€åæ›´æ–°: " + data.lastUpdate;
      }

      // åŠ è½½æ—¥å¿—
      function loadLogs() {
        fetch("activity_log.json?" + new Date().getTime())
          .then((response) => {
            if (!response.ok) {
              throw new Error("æ—¥å¿—æ–‡ä»¶ä¸å­˜åœ¨æˆ–æ— æ³•è®¿é—®");
            }
            return response.json();
          })
          .then((logs) => {
            updateLogsUI(logs);
          })
          .catch((error) => {
            console.error("åŠ è½½æ—¥å¿—å¤±è´¥:", error);
          });
      }

      // æ›´æ–°æ—¥å¿—UI
      function updateLogsUI(logs) {
        const logContainer = document.getElementById("logContainer");
        logContainer.innerHTML = ""; // æ¸…ç©ºç°æœ‰æ—¥å¿—

        if (logs.length === 0) {
          const emptyLog = document.createElement("div");
          emptyLog.className = "log-entry";
          emptyLog.textContent = "æš‚æ— æ—¥å¿—è®°å½•";
          logContainer.appendChild(emptyLog);
          return;
        }

        // æ·»åŠ æœ€æ–°çš„50æ¡æ—¥å¿—ï¼ˆå¦‚æœè¶…è¿‡50æ¡ï¼‰
        const recentLogs = logs.slice(-50);

        recentLogs.forEach((log) => {
          const logEntry = document.createElement("div");
          logEntry.className = "log-entry";

          // å¦‚æœæ˜¯é”™è¯¯æ—¥å¿—ï¼Œæ·»åŠ é”™è¯¯æ ·å¼
          if (log.message.startsWith("é”™è¯¯:")) {
            logEntry.className += " error";
          }

          logEntry.textContent = log.timestamp + " - " + log.message;
          logContainer.appendChild(logEntry);
        });

        // æ»šåŠ¨åˆ°æœ€æ–°æ—¥å¿—
        logContainer.scrollTop = logContainer.scrollHeight;
      }
    </script>
  </body>
</html>
